name: MacOS build

on: [push, pull_request]

jobs:
  build:

    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: 
          - macos-latest
          - ubuntu-latest
          - windows-latest
        raku-release:
          - 2020.06-01
          - 2020.05.1-01
                
    steps:
         
    - uses: actions/checkout@v2
             
    - name: Set Raku install Path Unix format
#       if: ${{ ! startsWith(matrix.os, 'windows') }}
      run: |
        echo "::set-env name=RAKU_INSTALL_PATH::$HOME/raku-${{ matrix.raku-release }}"
        echo "::set-env name=RAKU_INSTALL_PATH_UX::$HOME/raku-${{ matrix.raku-release }}" 
        if [[ "${{ matrix.os }}" = windows* ]]
        then
          echo "::set-env name=RAKU_OS::win"
        elif  [[ "${{ matrix.os }}" = ubuntu* ]]
        then
          echo "::set-env name=RAKU_OS::linux"
        else
          echo "::set-env name=RAKU_OS::macos"
        fi        
      shell: bash

    - name: Set Raku install Path (Windows)
      if: ${{ startsWith(matrix.os, 'windows') }}
      run: |
        echo "::set-env name=RAKU_INSTALL_PATH::$HOME\raku-${{ matrix.raku-release }}" 
              
    - name: Check Cache
      id: my-cache
      uses: actions/cache@v2
      with:
        path: ${{ env.RAKU_INSTALL_PATH }}
        key: ${{ matrix.raku-release }}-x12
    
            # Convert windows path to Unix-style
            #InstallPath=$( echo ${{ env.RAKU_INSTALL_PATH }} | sed -e's#\\#/#g' -e's#^\(.\):#\L\1#')        
            #echo $InstallPath
            
    - name: Install Raku (Linux/MacOS)
      if: ${{ steps.my-cache.outputs.cache-hit != 'true' }}
#       if: ${{ ! startsWith(matrix.os, 'windows') && steps.my-cache.outputs.cache-hit != 'true' }}
      run: |
        mkdir -p ${{ env.RAKU_INSTALL_PATH_UX }}        
        cd ${{ env.RAKU_INSTALL_PATH_UX }}
        
        if [[ "${{ matrix.os }}" = windows* ]]
        then
            RAKU_OS=win
            curl -s https://rakudo.org/dl/rakudo/rakudo-moar-${{ matrix.raku-release }}-win-x86_64.zip >tmp.zip
            unzip tmp.zip
            rm tmp.zip
        elif  [[ "${{ matrix.os }}" = ubuntu* ]]
        then
            RAKU_OS=linux   
            curl -s https://rakudo.org/dl/rakudo/rakudo-moar-${{ matrix.raku-release }}-linux-x86_64.tar.gz | tar xvzf - -C ${{ env.RAKU_INSTALL_PATH_UX }}
        else
            RAKU_OS=macos
            curl -s https://rakudo.org/dl/rakudo/rakudo-moar-${{ matrix.raku-release }}-macos-x86_64.tar.gz | tar xvzf - -C ${{ env.RAKU_INSTALL_PATH_UX }}            
        fi
        echo RAKU_OS=$RAKU_OS 
        pwd
        #curl -s https://rakudo.org/dl/rakudo/rakudo-moar-${{ matrix.raku-release }}-${{ env.RAKU_OS }}-x86_64.tar.gz >keep
        #file keep
        #curl -s https://rakudo.org/dl/rakudo/rakudo-moar-${{ matrix.raku-release }}-${{ env.RAKU_OS }}-x86_64.tar.gz | tar xvzf - -C ${{ env.RAKU_INSTALL_PATH_UX }}
        #ls ${{ env.RAKU_INSTALL_PATH_UX }}
        #BASE_RELEASE=$( ls )
        #echo $BASE_RELEASE
        #echo "::set-env name=RAKU_BASE_PATH::${{ env.RAKU_INSTALL_PATH_UX }}/${BASE_RELEASE}"
        
      shell: bash
                
      
    # Install zip for use in the test harness
    - name: Install zip (Windows)
      if: ${{ startsWith(matrix.os, 'windows') }}
      run: |
        choco install zip
        zip -v
        
    # Install unzip for use in the test harness  
    - name: Install unzip (Windows)
      if: ${{ startsWith(matrix.os, 'windows') }}      
      run: |
        choco install unzip
        unzip -v
        
    - name: Get Path for Raku 
      run: |
        cd ${{ env.RAKU_INSTALL_PATH_UX }}
        BASE_RELEASE=$( ls )     
        if [[ "${{ matrix.os }}" = windows* ]]
        then        
          echo "::set-env name=RAKU_BASE_PATH::${{ env.RAKU_INSTALL_PATH }}\\$BASE_RELEASE" 
        else
          echo "::set-env name=RAKU_BASE_PATH::${{ env.RAKU_INSTALL_PATH }}/$BASE_RELEASE"         
        fi
      shell: bash

              
    - name: Set Path for Raku (Linux/MacOS)
      run: |        
        if [[ "${{ matrix.os }}" = windows* ]]
        then           
          echo "::add-path::$RAKU_BASE_PATH\\bin"
          echo "::add-path::$RAKU_BASE_PATH\\share\\perl6\\site\\bin"   
        else
          echo "::add-path::$RAKU_BASE_PATH/bin"
          echo "::add-path::$RAKU_BASE_PATH/share/perl6/site/bin"           
        fi
      shell: bash      
                
        
    - name: Raku  version
      run: raku -v
#       shell: bash

    - name: Install module dependencies
      if: steps.my-cache.outputs.cache-hit != 'true'
      run:  zef install --deps-only .          
#       shell: bash

              
    - name: Run module tests
      run:  zef test --verbose .
#       shell: bash

        


